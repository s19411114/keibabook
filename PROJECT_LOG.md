# 競馬ブック スクレイパー プロジェクトログ

## 1. プロジェクト目標

競馬ブックのサイトからレース関連の全情報（出馬表、調教、血統、コメント等）を抽出し、以下の2形式でデータを出力するシステムを構築する。

1.  **レースごとの詳細JSONファイル:** 1レースの全情報を階層構造で格納。AIによる詳細分析や、単一レースの深掘りに使用する。
2.  **データベース用CSVファイル群:** 全レースのデータを正規化されたテーブル形式で出力。将来的なデータベース構築と大規模な統計分析を目的とする。

## 2. 現在の状況 (2025-11-10)

-   **完了:**
    -   基本的なスクレイパーの枠組みを構築完了。
    -   テスト駆動開発(TDD)のセットアップ完了。
    -   WSL環境からWindowsのChromeブラウザを操作するデバッグ手法を確立。
    -   `debug_page.html` を用いたHTML分析により、CSSセレクタの不一致問題を特定・修正。
    -   **出馬表ページの基本情報（レース名、馬リスト等）のスクレイピングに成功。**
    -   **調教、血統、コメントデータの取得機能を実装完了。**
    -   **CSVデータベース管理機能を実装（重複チェック、差分取得対応）。**
    -   **Streamlit GUIを実装（ブラウザベースの操作インターフェース）。**
    -   **エラーハンドリングとリトライ機能を追加。**
    -   **馬柱（能力表）HTMLからのデータ取得機能を実装（個別馬ページ遷移を削除）。**

-   **現在のタスク:**
    -   馬柱HTMLの実際の構造に合わせてパーサーを調整（必要に応じて）。
    -   中央競馬と地方競馬の両対応（UIの分岐実装）。
    -   定期実行機能の実装（schedule/apscheduler）。
    -   買い目アドバイス機能の要件定義（将来実装）。

## 3. 開発・実行マニュアル

### 3.1. 開発環境のセットアップ

> **注意**: プロジェクトの標準は Docker です。以下の venv 手順はレガシーです。Docker のセットアップ方法は `DOCKER_SETUP.md` を参照してください。

1.  **プロジェクトディレクトリに移動:**
    ```bash
    cd /mnt/c/geminicli/test/keibabook
    ```
2.  **旧来の仮想環境をアクティベート (レガシー)**
    ```bash
    source .venv/bin/activate
    ```
    (プロンプトの先頭に `(venv)` が表示される)

### 3.2. スクレイパーの実行

-   `config/settings.yml` で指定されたレースのスクレイピングを実行する。
    ```bash
    PYTHONPATH=. /mnt/c/geminicli/test/keibabook/venv/bin/python run_scraper.py
    ```

### 3.3. テストの実行

-   プロジェクトの単体テストを実行する。
    ```bash
    PYTHONPATH=. /mnt/c/geminicli/test/keibabook/venv/bin/pytest
    ```

## 4. 開発履歴・決定事項

-   **2025-11-09:**
    -   WSL環境でのGUIブラウザ表示問題を解決するため、HTMLをファイルに保存してデバッグする手法に切り替え、成功。
    -   CSSセレクタのズレがデータ取得失敗の原因であることを特定し、`_parse_race_data`を修正。出馬表のデータ取得に成功した。
    -   今後の拡張性を考慮し、まず中央競馬(JRA)のスクレイパーを完成させ、その後に地方競馬(NAR)に対応する方針を決定。
    -   サイトへの負荷を考慮し、一度取得したデータはキャッシュし、過去データは時間をかけて収集する倫理的なスクレイピング方針に合意。

-   **2025-11-10:**
    -   **CSVデータベース管理機能を実装** (`src/utils/db_manager.py`)
        -   URLログによる重複チェック機能
        -   レース・馬データのCSV保存
        -   AI用JSONエクスポート機能
    -   **Streamlit GUIを実装** (`app.py`)
        -   ブラウザベースの操作インターフェース
        -   レース選択、スクレイピング実行、進捗表示
        -   データ確認、ログ表示機能
    -   **スクレイパーの改善**
        -   リトライ機能付きページ取得（指数バックオフ）
        -   重複チェック統合（DBマネージャー連携）
        -   馬柱HTMLからのデータ取得（個別馬ページ遷移を削除）
        -   エラーハンドリングとログ出力の強化
    -   **仮想環境セットアップ手順書を作成** (`SETUP.md`)
        -   WSL/Ubuntu環境での推奨セットアップ手順
        -   トラブルシューティング情報

## 5. AI評価基準 (2025-11-10)

AIによる競馬予測の精度を向上させるため、以下の情報重要度と評価基準を設ける。

### 5.1. 情報の重要度

データ収集および特徴量エンジニアリングにおいて、以下の序列を優先する。

1.  **血統**
2.  **調教**
3.  **馬柱**
4.  **スピード指数**
5.  **レーティング**
6.  **ファクター（印）**
7.  **出馬表下の総合指数**（オッズの代替として解釈）

### 5.2. 評価の但し書き

収集したデータをAIモデルに適用する際、以下の基準を考慮する。これにより、モデルへの入力を標準化し、一貫性のある評価を目指す。

-   **① 過去走の凡走:**
    -   明らかな展開不利や不利な馬場状態など、明確な理由がある凡走は外れ値として扱い、評価から除外、または重みを下げる。
    -   凡走理由は「過去走コメント」「厩舎コメント」を参照して判断する。
-   **② 意図的な凡走（叩き）:**
    -   連闘などで調整目的（叩き）と判断される凡走（特に調教内容が軽い場合）は、外れ値として扱い、マイナス評価しない。
    -   調教データは、特に評価が高い（プラス評価）馬を重視する。
-   **③ 凡走と好走を繰り返す馬:**
    -   一貫性のない成績の馬は「要注意の穴馬」としてフラグを立て、別途分析対象とする。
-   **④ 高齢馬:**
    -   年齢による一律な割引は避け、近走の内容や調教気配を重視し、穴馬としての可能性を探る。
-   **⑤ 斤量:**
    -   斤量の絶対値だけでなく、馬体重に対する斤量比を重要なファクターとして評価する。
