Category: Guide
Status: Active

# データ取得戦略

⚠️ **削除禁止** - 両サイトの役割分担を明確化

> **Policy Update (2025-12-06): Netkeiba historical + track-bias migration**
>
> - Netkeiba の過去レース収集（アーカイブ）、Netkeiba DB スクレイパー、`track_bias` 計算、`run_pedigree` バッチは keiba-ai に移管します。
> - keibabook は今後、1レース分のJSON生成と keibabook 固有の情報（レース後のコメント、調教、ポイント等）に集中します。
> - 移管候補のコード／スクリプトは `migration/to_keiba_ai/` にまとめています（参照: migration/to_keiba_ai/manifest.md）。
>
## 基本方針: 両サイト併用で補完

### 競馬ブック（メインデータソース）

**取得タイミング**: その週の予想に必要なデータをリアルタイム取得

#### 📥 スクレイピングタブで取得
- **三代血統（14頭）** - Netkeibaの五代は複雑すぎるため競馬ブック優先
  - 1代前: 父、母
  - 2代前: 父父、父母、母父、母母
  - 3代前: 父父父、父父母、父母父、父母母、母父父、母父母、母母父、母母母
- **CPU予想・印**
- **展開予想**（ペース、隊列）
- **ポイント**（大穴馬、激走馬、AI血統予想など）
- **前走コメント**

#### 🏇 レース後（トラックバイアスタブで取得）
- **レース後コメント** ⭐ Netkeibaにはない重要情報
- **次走へのメモ** ⭐ 次回の予想に活用

**実装**: `src/scrapers/keibabook.py` (既存)

---

### Netkeiba DB（アーカイブ・補完データソース）

**取得タイミング**: 過去データを一括取得してアーカイブ化

#### 📊 トラックバイアス分析用
- **過去レース結果** (`Results` クラス)
  - 着順、馬番、馬名、騎手、タイム
  - レース種別（芝/ダート）、距離、天候、馬場状態
  - 通過順位、上がり3F、人気、オッズ
- **払い戻し履歴** (`Return` クラス)
  - 単勝、複勝、枠連、馬連、馬単、ワイド、三連複、三連単

#### 🐴 馬の長期傾向分析用
- **馬の過去成績** (`HorseResults` クラス)
  - 日付、開催、レース名、着順
  - クラス、距離、コース、馬場状態
  - 騎手、斤量、タイム

**実装**: `src/scrapers/netkeiba_db_scraper.py` (新規作成)

---

## データの重複回避

### 血統データ
- **競馬ブック優先**: 三代血統（14頭）で十分
- **Netkeiba の五代血統は使わない**: 複雑すぎて混乱の原因

### レース結果
- **当日の予想**: 競馬ブック（CPU予想、展開予想、ポイント）
- **過去レースのアーカイブ**: Netkeiba DB（トラックバイアス分析用）

### コメント
- **競馬ブック独占**: レース後コメント、次走へのメモ
- Netkeibaにはコメント機能がないため競馬ブックのみ

---

## 実装優先順位

### Phase 1: 現行維持（✅ 完了）
- 競馬ブックからその週の予想データを取得
- トラックバイアスタブでNetkeiba結果ページから取得＋DB保存

### Phase 2: アーカイブ機能追加（🔜 次のステップ）
1. Netkeiba DB スクレイパーのテスト実行
2. 過去レースID一覧の生成機能（例: 2023年〜2025年の重賞レース）
3. バッチ取得機能（週末に自動実行）
4. トラックバイアス履歴との統合

### Phase 3: レース後コメント活用（🚀 将来）
1. 競馬ブックのレース後ページから「次走へのメモ」を取得
2. DB保存して次回の予想時に参照
3. AI分析で馬の調子傾向を学習

---

## URL一覧

### 競馬ブック
- 出馬表: `https://s.keibabook.co.jp/cyuou/cyokyo/0/{race_id}`
- 血統: `https://s.keibabook.co.jp/cyuou/kettou/{race_id}`
- 調教: `https://s.keibabook.co.jp/cyuou/cyoukyo/{race_id}`
- レース後: `https://s.keibabook.co.jp/cyuou/kekka/{race_id}` ⭐

### Netkeiba DB
- レース結果: `https://db.netkeiba.com/race/{race_id}`
- 馬成績: `https://db.netkeiba.com/horse/{horse_id}`
- 血統: `https://db.netkeiba.com/horse/ped/{horse_id}` （使用しない）

---

## メンテナンス履歴

- 2025-11-30: 初版作成 - 両サイト併用戦略を明確化
- 血統は競馬ブック優先（三代14頭）、Netkeibaの五代は使わない
- レース後コメントは競馬ブック独占機能